{% extends "base.html" %}

{% block style %}

<style>
    h2 {
        color: #333;
    }
    .settings-form {
        max-width: 600px;
        margin: 0 auto;
    }
    .settings-form label {
        display: block;
        margin-top: 20px;
        font-weight: bold;
    }
    .settings-form input[type="password"],
    .settings-form input[type="text"],
    .settings-form textarea {
        width: 100%;
        padding: 10px;
        margin-top: 5px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
    }
    .settings-form input[type="submit"] {
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .settings-form input[type="submit"]:hover {
        background-color: #218838;
    }
    .settings-form .api-key-toggle {
        cursor: pointer;
        margin-left: 10px;
        color: #007bff;
        text-decoration: underline;
    }
</style>

{% endblock %}

{% block content %}

<div id="myModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>DistanceMatrix.AI</h2>
            <p>As part of the program's logic, the travel time between the locations of two matches is required.</p>
            <p>In order to do this, the program automatically connects to a website called <a href="https://distancematrix.ai/" target="_blank">Distancematrix.AI</a>. This website does all the heavily lifting for computing the travel time between two geographical points - kind of like the way Google Maps gives you an estimated travel time whenver you want directions.</p>

            <p>Included with the Head of Umpiring or Vice President handover document should be the club's login details and API key for this DistanceMatrix.AI website. Think of an API key as a type of password. It is randomly generated by the website for your use and your use only, so don't go sharing it. Whenever The BuzzBot 'talks' to this website, it uses the API provided here to let the website know who is talking to it. Think of it like a username and password combined.</p>
        </div>
    </div>

    <h2>Settings</h2>
<!--    <pre id="currentSettings">{{ config.settings | tojson(indent=2) }}</pre>-->

    <form class="settings-form" onsubmit="updateSettings(event);">
        <fieldset>
            <legend>API Configuration</legend>
            <label for="dm_ai_api_key">DistanceMatrix.AI API Key:</label>
            <button id="openModalBtn" type="button">Help?</button>
            <input type="password" id="dm_ai_api_key" name="dm_ai_api_key" value="{{ config.settings['distance_matrix_ai']['api_key'] }}">
            <i class="api-key-toggle" id="toggleAPIkey" style="width: 50vw;">Show</i>
        </fieldset>

        <fieldset>
            <legend>BuzzBot Configuration</legend>
            <label for="taglines_input">Taglines for The BuzzBot to say. Put each phrase on a new line:</label>
            <textarea rows="5" cols="80" id="taglines_input" name="taglines_input">{{ config.settings['taglines'] | join('\n') }}</textarea><br><br>

            <label for="teams_input">Teams:</label>
            <textarea rows="5" cols="80" id="teams_input" name="teams_input">{{ config.settings['teams'] | join('\n') }}</textarea><br><br>
        </fieldset>

        <input type="submit" value="Save settings">
    </form>

{% endblock %}


{% block scripts %}
<!--<script>-->
<!--        const apiField = document.getElementById('dm_ai_api_key');-->
<!--        const toggleButton = document.getElementById('toggleAPIkey');-->

<!--        toggleButton.addEventListener('click', function() {-->
<!--            const type = apiField.getAttribute('type') === 'password' ? 'text' : 'password';-->
<!--            apiField.setAttribute('type', type);-->
<!--            toggleButton.textContent = type === 'password' ? 'Show' : 'Hide';-->
<!--        });-->
<!--</script>-->

<script>
    async function updateSettings(event) {
        event.preventDefault();
        const dmAiApiKey = document.getElementById('dm_ai_api_key').value;
        const taglinesInput = document.getElementById('taglines_input').value;
        const teamsInpit = document.getElementById('teams_input').value;

        const response = await fetch('/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                dm_ai_api_key: dmAiApiKey,
                taglines_input: taglinesInput,
                teams_input: teamsInpit
            }),
        });

        if (response.redirected) {
            window.location.href = response.url;
        }
    }

    function toggleApiKeyVisibility() {
        const apiKeyInput = document.getElementById('dm_ai_api_key');
        const toggleBtn = document.getElementById('toggleAPIkey');
        if (apiKeyInput.type === 'password') {
            apiKeyInput.type = 'text';
            toggleBtn.innerText = 'Hide';
        } else {
            apiKeyInput.type = 'password';
            toggleBtn.innerText = 'Show';
        }
    }

    document.addEventListener('DOMContentLoaded', (event) => {
        document.getElementById('toggleAPIkey').addEventListener('click', toggleApiKeyVisibility);
    });
</script>

<script>
<!--        Script for loading the modal help window -->
    document.addEventListener("DOMContentLoaded", function () {
        var modal = document.getElementById("myModal");
        var btn = document.getElementById("openModalBtn");
        var span = document.getElementsByClassName("close")[0];

        btn.onclick = function () {
            event.preventDefault()
            modal.style.display = "block";
        }

        span.onclick = function () {
            modal.style.display = "none";
        }

        window.onclick = function (event) {
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }
    });
</script>

{% endblock %}
